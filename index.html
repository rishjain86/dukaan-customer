<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dukaan Customer App</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <style>
    :root{
      --accent:#6c5ce7;
      --accent2:#a280ff;
      --bg:#f5f6fb;
    }
    body{background:var(--bg);font-family:Inter,Roboto;}
    .top{background:var(--accent);color:#fff;padding:12px 16px;font-size:18px;font-weight:600;}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(170px,1fr));gap:16px;margin-top:20px;}
    .card-box{background:#fff;padding:12px;border-radius:12px;box-shadow:0 4px 14px rgba(0,0,0,0.05);}
    .thumb{width:100%;height:130px;object-fit:cover;border-radius:10px;background:#eee;}
    .price{color:var(--accent);font-weight:700;margin-top:3px;}
    .old{text-decoration:line-through;color:#777;font-size:13px;margin-left:4px;}
    .btn-add{background:var(--accent);color:#fff;border:0;border-radius:8px;padding:6px 14px;margin-top:10px;}
    .floating{position:fixed;bottom:18px;right:18px;background:var(--accent);color:#fff;padding:10px 18px;border-radius:30px;box-shadow:0 4px 14px rgba(0,0,0,0.2);cursor:pointer;font-weight:600;z-index:20;}
    .badge-cart{background:#ff4d6d;padding:4px 8px;border-radius:50%;font-size:12px;margin-left:6px;}
  </style>
</head>

<body>

<div class="top">ðŸ›’ Dukaan â€” Order Now</div>

<div class="container py-3">
  <select id="category" class="form-select mb-3">
    <option value="">All Categories</option>
  </select>

  <input id="search" class="form-control mb-3" placeholder="Search items..."/>

  <div id="grid" class="grid"></div>

  <div id="empty" style="text-align:center;margin-top:40px;color:#777;display:none;">
    No items found.
  </div>
</div>

<div class="floating" onclick="openCart()">Cart <span id="cartCount" class="badge-cart">0</span></div>

<!-- Cart Modal -->
<div class="modal fade" id="cartModal">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header"><h5>Your Cart</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="cartBody"></div>
      <div class="modal-footer">
        <div class="me-auto fw-bold">Total: <span id="cartTotal">â‚¹0</span></div>
        <button class="btn btn-success" onclick="checkout()">Place Order</button>
      </div>
    </div>
  </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="okModal">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-3 text-center">
      <h5 class="text-success fw-bold">Order Placed Successfully!</h5>
      <p class="small">Thanks for ordering.</p>
      <button class="btn btn-primary" data-bs-dismiss="modal">OK</button>
    </div>
  </div>
</div>


<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAomDsqeLOrXvnudqUsudnZWOphuqM0bvY",
  authDomain: "shopkeeper-99756.firebaseapp.com",
  projectId: "shopkeeper-99756",
  storageBucket: "shopkeeper-99756.appspot.com"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let shopId = "SHOP001";
let all = [];
let cart = JSON.parse(localStorage.getItem("cust_cart") || "[]");

function saveCart(){ localStorage.setItem("cust_cart",JSON.stringify(cart)); }
function updateBadge(){ 
  document.getElementById("cartCount").textContent = cart.reduce((a,b)=>a+b.qty,0); 
}
updateBadge();

function fmt(n){ return "â‚¹" + (Number(n)||0); }

function loadItems(){
  db.collection("shops").doc(shopId).collection("items").orderBy("name")
    .onSnapshot(snap=>{
      all = [];
      let cats = new Set();
      snap.forEach(d=>{
        let x = d.data(); x.id=d.id;
        all.push(x);
        if(x.category) cats.add(x.category);
      });
      renderCats([...cats]);
      renderItems();
    });
}

function renderCats(cats){
  let c = document.getElementById("category");
  c.innerHTML = "<option value=''>All Categories</option>";
  cats.forEach(k=>{
    c.innerHTML += `<option>${k}</option>`;
  });
}

function renderItems(){
  let q = document.getElementById("search").value.toLowerCase();
  let cat = document.getElementById("category").value;

  let list = all.filter(it=>{
    if(cat && it.category!==cat) return false;
    if(q && !it.name.toLowerCase().includes(q)) return false;
    return true;
  });

  let g = document.getElementById("grid");
  g.innerHTML = "";
  if(list.length===0){
    document.getElementById("empty").style.display="block";
    return;
  }
  document.getElementById("empty").style.display="none";

  list.forEach(it=>{
    let price = it.offerPrice ?? it.price ?? 0;

    g.innerHTML += `
      <div class="card-box">
        <img src="${it.imageUrl || 'https://via.placeholder.com/400x300'}" class="thumb"/>
        <div class="fw-bold mt-2">${it.name}</div>
        <div class="text-muted small">${it.category||""}</div>
        <div class="price">${fmt(price)} ${
          it.offerPrice && it.price ? `<span class='old'>${fmt(it.price)}</span>`:""
        }</div>
        <button class="btn-add" onclick="addToCart('${it.id}')">Add to Cart</button>
      </div>
    `;
  });
}

function addToCart(id){
  let it = all.find(x=>x.id===id);
  if(!it) return;
  let c = cart.find(x=>x.id===id);
  if(c) c.qty++;
  else cart.push({ id:id, name:it.name, price:(it.offerPrice ?? it.price ?? 0), qty:1 });
  saveCart(); updateBadge();
}

function openCart(){
  renderCart();
  new bootstrap.Modal(document.getElementById("cartModal")).show();
}

function renderCart(){
  let body = document.getElementById("cartBody");
  if(cart.length===0){
    body.innerHTML = "<p class='text-center'>Cart is empty</p>";
    document.getElementById("cartTotal").textContent="â‚¹0";
    return;
  }
  let t=0;
  let html="<table class='table'>";
  cart.forEach(ci=>{
    let sub = ci.qty * ci.price;
    t+=sub;
    html+=`
    <tr>
      <td><b>${ci.name}</b></td>
      <td>
        <button class="btn btn-sm btn-outline-secondary" onclick="qty('${ci.id}',-1)">-</button>
        <span class="mx-2">${ci.qty}</span>
        <button class="btn btn-sm btn-outline-secondary" onclick="qty('${ci.id}',1)">+</button>
      </td>
      <td>${fmt(sub)}</td>
      <td><button class="btn btn-sm btn-danger" onclick="removeItem('${ci.id}')">X</button></td>
    </tr>`;
  });
  html+="</table>";
  body.innerHTML=html;
  document.getElementById("cartTotal").textContent=fmt(t);
}

function qty(id,d){
  let i=cart.findIndex(c=>c.id===id);
  if(i==-1) return;
  cart[i].qty+=d;
  if(cart[i].qty<=0) cart.splice(i,1);
  saveCart(); renderCart(); updateBadge();
}
function removeItem(id){ cart=cart.filter(c=>c.id!==id); saveCart(); renderCart(); updateBadge(); }

function checkout(){
  if(cart.length===0) return alert("Cart empty");

  let name = prompt("Name");
  if(!name) return;
  let phone = prompt("Phone");
  if(!phone) return;
  let addr = prompt("Address");
  if(!addr) return;

  let order = {
    customer:{name,phone,address:addr},
    items:cart,
    total:cart.reduce((s,i)=>s+i.qty*i.price,0),
    shopId:shopId,
    status:"placed",
    createdAt:firebase.firestore.FieldValue.serverTimestamp()
  };

  db.collection("shops").doc(shopId).collection("orders").add(order)
    .then(()=>{
      cart=[]; saveCart(); updateBadge();
      new bootstrap.Modal(document.getElementById("cartModal")).hide();
      new bootstrap.Modal(document.getElementById("okModal")).show();
    })
    .catch(e=>{
      alert("Order error: "+e.message);
    });
}

document.getElementById("search").addEventListener("input",renderItems);
document.getElementById("category").addEventListener("change",renderItems);

loadItems();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
